<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#f6f8fc;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6eaf2;

      --primary:#2563eb;
      --primarySoft:#eff6ff;

      --link:#6aa7ff;
      --linkHover:#3b82f6;

      --danger:#e11d48;
      --dangerSoft:#fff1f2;

      --shadowSm: 0 1px 2px rgba(2,6,23,.06);
      --shadowMd: 0 10px 28px rgba(2,6,23,.10);

      --r12:12px;
      --r16:16px;
      --r20:20px;

      --fs11:11px;
      --fs12:12px;
      --fs13:13px;
      --fs14:14px;
      --fs16:16px;
      --fs20:20px;
      --fs26:26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== App shell ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      background: var(--panel);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:18px 14px;
      overflow:hidden;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 6px 8px 2px;
    }
    .logo{
      width:38px; height:38px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(37,99,235,.03));
      border: 1px solid rgba(37,99,235,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color: var(--primary);
      letter-spacing:.3px;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      gap:3px;
      min-width:0;
    }
    .brandText .t1{ font-size: var(--fs16); font-weight: 900; letter-spacing: -.02em; }
    .brandText .t2{ font-size: var(--fs12); color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{
      flex:1;
      overflow:auto;
      padding: 4px;
    }
    .navGroup{ margin: 10px 4px 6px; font-size: var(--fs11); letter-spacing:.08em; font-weight:800; color: var(--muted); text-transform:uppercase; }
    .navBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid transparent;
      background: transparent;
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      font:inherit;
      text-align:left;
    }
    .navBtn:hover{ background: rgba(15,23,42,.035); }
    .navBtn.active{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.18);
      color: var(--primary);
    }
    .navBtn .left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .navIco{
      width:34px; height:34px; border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .navLabel{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .navLabel b{ font-size: var(--fs14); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .navLabel span{ font-size: var(--fs12); color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .navMeta{
      font-size: var(--fs12);
      color: var(--muted);
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding: 4px 8px;
      white-space:nowrap;
    }

    .sidebarFoot{
      border-top:1px solid var(--border);
      padding: 12px 8px 4px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .userBadge{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px 8px 12px;
      box-shadow: var(--shadowSm);
    }
    .userInfo{
      display:flex;
      flex-direction:column;
      gap:1px;
      min-width:0;
    }
    .userInfo b{ font-size: var(--fs13); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .userInfo span{ font-size: var(--fs12); color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .logoutBtn{
      border:none;
      background: var(--dangerSoft);
      color: var(--danger);
      font-weight: 900;
      font-size: var(--fs12);
      border-radius: 999px;
      padding: 7px 10px;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ===== Main viewport ===== */
    .viewport{
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .header{
      height: 68px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 0 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(246,248,252,.78);
      backdrop-filter: blur(10px);
    }

    .crumbs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      min-width: 0;
    }
    .crumb{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding: 6px 10px;
      font-size: var(--fs12);
      cursor:pointer;
      max-width: 240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .crumb:hover{ background: rgba(15,23,42,.035); }
    .crumbSep{
      color: var(--muted);
      font-weight:800;
      font-size: var(--fs12);
      user-select:none;
    }

    .headerRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width: 260px;
    }
    .kbd{
      font-family: var(--mono);
      font-size: var(--fs12);
      color: var(--muted);
      border:1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 6px 8px;
      white-space:nowrap;
    }

    /* ===== 2-panel workspace (Explorer + Reader) ===== */
    .content{
      flex:1;
      overflow:hidden;
      padding: 16px 18px 18px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r20);
      box-shadow: var(--shadowMd);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .panelHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead h3{
      margin:0;
      font-size: var(--fs13);
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .pill{
      font-size: var(--fs12);
      color: var(--muted);
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding: 4px 8px;
      white-space:nowrap;
    }
    .panelBody{
      flex:1;
      overflow:auto;
      padding: 12px;
      min-height:0;
    }

    /* Explorer toolbar */
    .explToolbar{
      display:flex;
      gap:10px;
      padding: 12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
    }
    .miniBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font:inherit;
      cursor:pointer;
      white-space:nowrap;
    }
    .miniBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .search{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font:inherit;
      outline:none;
    }
    .search:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    /* Explorer items */
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 12px;
    }

    .item{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .item:hover{ background: rgba(15,23,42,.02); }
    .item.active{
      border-color: rgba(37,99,235,.35);
      background: var(--primarySoft);
    }
    .itemLeft{
      display:flex; gap:10px; min-width:0;
    }
    .itemIco{
      width:36px; height:36px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .itemText{
      display:flex; flex-direction:column; gap:3px; min-width:0;
    }
    .itemText b{ font-size: var(--fs14); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .itemText span{ font-size: var(--fs12); color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .itemRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      flex:0 0 auto;
    }
    .count{
      font-family: var(--mono);
      font-size: var(--fs12);
      color: var(--muted);
      border:1px solid var(--border);
      border-radius: 999px;
      background:#fff;
      padding: 4px 8px;
    }
    .tag{
      font-size: var(--fs11);
      font-weight: 800;
      color: var(--primary);
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.20);
      border-radius:999px;
      padding: 3px 8px;
      white-space:nowrap;
    }

    /* Reader document */
    .doc{
      max-width: 860px;
      margin: 0 auto;
      padding: 8px 6px 24px;
    }
    .docTitle{
      margin: 6px 0 8px;
      font-size: var(--fs26);
      letter-spacing: -.02em;
      font-weight: 900;
    }
    .docSub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: var(--fs13);
      line-height: 1.45;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin: 16px 0 10px;
    }
    .heroCard{
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--r16);
      padding: 14px;
      box-shadow: var(--shadowSm);
      min-height: 90px;
    }
    .heroCard h4{
      margin:0 0 6px;
      font-size: var(--fs14);
    }
    .heroCard p{
      margin:0;
      color: var(--muted);
      font-size: var(--fs13);
      line-height:1.45;
    }
    .tiles{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .tile{
      border:1px solid var(--border);
      border-radius: var(--r16);
      padding: 12px;
      background: #fff;
      box-shadow: var(--shadowSm);
      cursor:pointer;
    }
    .tile:hover{ background: rgba(15,23,42,.02); }
    .tile b{ display:block; font-size: var(--fs14); margin-bottom:4px; }
    .tile span{ display:block; font-size: var(--fs12); color: var(--muted); }

    /* Links */
    a{
      color: var(--link);
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    a:hover{ color: var(--linkHover); }

    /* Details styling */
    details{
      border:1px solid var(--border);
      border-radius: var(--r16);
      background: rgba(15,23,42,.015);
      padding: 10px 12px;
      margin: 10px 0;
    }
    details > summary{
      cursor:pointer;
      font-weight: 900;
      color: var(--primary);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details > summary::-webkit-details-marker{ display:none; }
    details[open]{
      background: rgba(37,99,235,.06);
      border-color: rgba(37,99,235,.18);
    }

    .muted{ color: var(--muted); }
    .small{ font-size: var(--fs12); }

    .alert{
      border:1px solid rgba(225,29,72,.22);
      background: rgba(225,29,72,.06);
      color: #8a0f2d;
      border-radius: var(--r16);
      padding: 10px 12px;
      margin: 0 0 10px;
    }

    /* Responsive */
    @media (max-width: 1100px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; height:auto; }
      .sidebar{
        position: sticky;
        top:0;
        z-index: 20;
        flex-direction:row;
        align-items:center;
        padding: 10px 10px;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      .nav{ display:flex; gap:8px; overflow:auto; padding: 0; }
      .navGroup{ display:none; }
      .navBtn{ min-width: 220px; }
      .sidebarFoot{ display:none; }

      .viewport{ height:auto; }
      .header{ position: sticky; top: 58px; }
      .content{ grid-template-columns: 1fr; height:auto; }
      .panel{ min-height: 380px; }
      .heroGrid{ grid-template-columns: 1fr; }
    }

    /* ===========================================
       Stop ‚Äútext pop‚Äù (scrollbar width change)
       =========================================== */

    /* Keep scrollbar space reserved so content width never changes */
    #reader{
      overflow-y: auto;
      scrollbar-gutter: stable; /* modern Chrome */
    }

    /* Fallback for environments that ignore scrollbar-gutter */
    @supports not (scrollbar-gutter: stable){
      #reader{
        overflow-y: scroll; /* always show scrollbar */
      }
    }

    /* If scroll happens on panel body (common), stabilize that too */
    .panelBody{
      scrollbar-gutter: stable;
    }

    @supports not (scrollbar-gutter: stable){
      .panelBody{ overflow-y: scroll; }
    }

    /* ===== Surat dropdown ===== */
.suratRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.suratBtn{
  border:1px solid var(--border);
  background:#fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font:inherit;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.suratBtn:hover{ background: rgba(15,23,42,.02); }

.dropdown{
  margin-top:10px;
  border:1px solid var(--border);
  border-radius: var(--r16);
  background:#fff;
  box-shadow: var(--shadowSm);
  overflow:hidden;
}

.dropdownHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, rgba(37,99,235,.06), transparent);
}

.dropdownTools{
  display:flex;
  align-items:center;
  gap:8px;
}

.ddSearch{
  width: 260px;
  max-width: 42vw;
  border:1px solid var(--border);
  border-radius: 12px;
  padding: 8px 10px;
  outline:none;
  font:inherit;
}
.ddSearch:focus{
  border-color: rgba(37,99,235,.35);
  box-shadow: 0 0 0 4px rgba(37,99,235,.12);
}

.ddUploadBtn{
  border:1px solid rgba(37,99,235,.20);
  background: rgba(37,99,235,.10);
  color: var(--primary);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight:900;
  font-size: var(--fs12);
  white-space:nowrap;
}
.ddUploadBtn:hover{ background: rgba(37,99,235,.14); }

.ddBody{ padding: 10px 12px; }

.fileRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  padding: 10px 10px;
  border:1px solid var(--border);
  border-radius: 12px;
  background:#fff;
  margin-bottom:8px;
}
.fileRow:hover{ background: rgba(15,23,42,.02); }

.fileLeft{ min-width:0; }
.fileLeft b{
  display:block;
  font-size: var(--fs14);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 56vw;
}
.fileLeft span{
  display:block;
  font-size: var(--fs12);
  color: var(--muted);
  margin-top:2px;
}

.fileRight{
  display:flex;
  align-items:center;
  gap:8px;
  flex:0 0 auto;
}
.openBtn{
  border:1px solid var(--border);
  background:#fff;
  border-radius: 12px;
  padding: 7px 10px;
  cursor:pointer;
  font-size: var(--fs12);
  font-weight:900;
}
.openBtn:hover{ background: rgba(15,23,42,.02); }

    .delBtn{
      border:1px solid rgba(225,29,72,.25);
      background: var(--dangerSoft);
      color: var(--danger);
      border-radius: 12px;
      padding: 7px 10px;
      cursor:pointer;
      font-size: var(--fs12);
      font-weight:900;
    }
    .delBtn:hover{ background: rgba(225,29,72,.14); }


.ddHint{
  font-size: var(--fs12);
  color: var(--muted);
  padding: 8px 0 0;
}

  
    /* ===== Standardized Document Cards ===== */
    .docList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .docItem{
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--r16);
      padding: 12px 14px;
      box-shadow: var(--shadowSm);
    }

    .docItem:hover{
      background: rgba(15,23,42,.02);
    }

    .docHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }

    .docHead.noToggle{ cursor:default; }

    .docTitleRow{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }

    .docTitle{
      font-size: var(--fs14);
      font-weight: 900;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }

    .docMeta{
      font-size: var(--fs12);
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }

    .docBody{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--border);
      display:none;
    }

    .docItem.open .docBody{
      display:block;
    }

    .docLinks{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .docLinks a{
      font-size: var(--fs13);
    }

    .docP{
      margin: 0;
      color: var(--muted);
      font-size: var(--fs13);
      line-height: 1.5;
    }

  </style>

  <!-- Google Identity Services (for Drive OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>

<body>
  <div class="app">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">A</div>
        <div class="brandText">
          <div class="t1">AKADEMIK</div>
          <div class="t2" id="sidebarSub">Digital Workspace</div>
        </div>
      </div>

      <div class="nav" id="nav">
        <div class="navGroup">Main</div>
        <button class="navBtn active" data-section="home" onclick="selectSection('home')">
          <div class="left">
            <div class="navIco">üè†</div>
            <div class="navLabel">
              <b>Dashboard</b>
              <span>Overview & recent</span>
            </div>
          </div>
          <span class="navMeta">Home</span>
        </button>

        <? if (showPerdana) { ?>
          <div class="navGroup">Academic</div>
          <button class="navBtn" data-section="perdana" onclick="selectSection('perdana')">
            <div class="left">
              <div class="navIco">üéì</div>
              <div class="navLabel">
                <b>Perdana</b>
                <span>Kurikulum & panitia</span>
              </div>
            </div>
            <span class="navMeta">Modules</span>
          </button>
        <? } ?>

        <? if (allowedMap.koko) { ?>
          <button class="navBtn" data-section="koko" onclick="selectSection('koko')">
            <div class="left">
              <div class="navIco">üèÖ</div>
              <div class="navLabel">
                <b>Ko-kurikulum</b>
                <span>Aktiviti & evidens</span>
              </div>
            </div>
            <span class="navMeta">‚Äî</span>
          </button>
        <? } ?>

        <? if (allowedMap.ting6) { ?>
          <button class="navBtn" data-section="ting6" onclick="selectSection('Pengurusan Tingkatan 6')">
            <div class="left">
              <div class="navIco">üìò</div>
              <div class="navLabel">
                <b>Tingkatan 6</b>
                <span>STPM</span>
              </div>
            </div>
            <span class="navMeta">‚Äî</span>
          </button>
        <? } ?>

        <? if (allowedMap.ppki) { ?>
          <button class="navBtn" data-section="ppki" onclick="selectSection('ppki')">
            <div class="left">
              <div class="navIco">üß†</div>
              <div class="navLabel">
                <b>PPKI</b>
                <span>Pendidikan khas</span>
              </div>
            </div>
            <span class="navMeta">‚Äî</span>
          </button>
        <? } ?>

        <? if (allowedMap.kaunseling) { ?>
          <button class="navBtn" data-section="kaunseling" onclick="selectSection('kaunseling')">
            <div class="left">
              <div class="navIco">üí¨</div>
              <div class="navLabel">
                <b>Kaunseling</b>
                <span>Sokongan murid</span>
              </div>
            </div>
            <span class="navMeta">‚Äî</span>
          </button>
        <? } ?>

        <!-- HEM moved under ACADEMIC -->
        <? if (allowedMap.hem) { ?>
          <a class="navBtn" href="?page=hem&amp;sid=<?= sid ?>" target="_top" style="text-decoration:none;">
            <div class="left">
              <div class="navIco">üß©</div>
              <div class="navLabel">
                <b>HEM</b>
                <span>Route (GAS)</span>
              </div>
            </div>
            <span class="navMeta">‚Üó</span>
          </a>
        <? } ?>

        <!-- OTHER: Data / IDME / HRMIS -->
        <div class="navGroup">Other</div>

<a class="navBtn"
   href="<?= serviceUrl ?>?page=data&sid=<?= sid ?>"
   target="_blank"
   rel="noopener"
   style="text-decoration:none;">
  <div class="left">
    <div class="navIco">üìä</div>
    <div class="navLabel">
      <b>Data</b>
      <span>Internal page</span>
    </div>
  </div>
  <span class="navMeta">‚Üó</span>
</a>



        <a class="navBtn" href="https://idme.moe.gov.my/login" target="_blank" rel="noopener" style="text-decoration:none;">
          <div class="left">
            <div class="navIco">üß≠</div>
            <div class="navLabel">
              <b>IDME</b>
              <span>External portal</span>
            </div>
          </div>
          <span class="navMeta">‚Üó</span>
        </a>

        <a class="navBtn" href="https://hrmis2.eghrmis.gov.my/" target="_blank" rel="noopener" style="text-decoration:none;">
          <div class="left">
            <div class="navIco">üßë‚Äçüíº</div>
            <div class="navLabel">
              <b>HRMIS</b>
              <span>External (HR)</span>
            </div>
          </div>
          <span class="navMeta">‚Üó</span>
        </a>
      </div>

      <div class="sidebarFoot">
        <div class="userBadge">
          <div class="userInfo">
            <b id="uName"><?= username ?></b>
            <span id="uRole"><?= role ?></span>
          </div>
          <button class="logoutBtn" onclick="location.href='?page=logout&sid=<?= sid ?>'">EXIT</button>
        </div>
      </div>
    </aside>

    <!-- ===== Main viewport ===== -->
    <section class="viewport">
      <header class="header">
        <div class="crumbs" id="crumbs"></div>
        <div class="headerRight">
          <div class="kbd">Search: <b>/</b></div>
          <div class="kbd">Back: <b>Esc</b></div>
        </div>
      </header>

      <div class="content">
        <!-- Explorer -->
        <div class="panel">
          <div class="panelHead">
            <h3>Explorer</h3>
            <span class="pill" id="explPill">Dashboard</span>
          </div>

          <div class="explToolbar">
            <button class="miniBtn" id="backBtn" onclick="goBack()" disabled>‚Üê Back</button>
            <input class="search" id="q" placeholder="Search folders / documents‚Ä¶" oninput="filterList()" />
          </div>

          <div class="panelBody">
            <div class="list" id="explList"></div>
          </div>
        </div>

        <!-- Reader -->
        <div class="panel">
          <div class="panelHead">
            <h3>Document View</h3>
            <span class="pill" id="viewPill">Ready</span>
          </div>

          <div class="panelBody" id="reader">
            <? if (denied) { ?>
              <div class="alert"><?= denied ?></div>
            <? } ?>

            <!-- Views injected by JS -->
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== Demo-safe fallback (works even if GAS doesn't render vars) =====
    const DEMO = {
      username: "Demo User",
      role: "Pentadbir",
    };

    // If the page still contains "<?= username ?>" literal, we are NOT in GAS render mode
    function isTemplateLiteralStillThere() {
      const html = document.documentElement.innerHTML;
      return html.includes("<?= username ?>") || html.includes("<?= role ?>");
    }

    function patchDemoUserIfNeeded(){
      if(!isTemplateLiteralStillThere()) return;
      const nameEl = document.getElementById("uName");
      const roleEl = document.getElementById("uRole");
      if(nameEl) nameEl.textContent = DEMO.username;
      if(roleEl) roleEl.textContent = DEMO.role;
      const welcomeName = DEMO.username;
      window.__WELCOME_NAME__ = welcomeName;
    }

    // ===== App state =====
    const state = {
      section: "home",
      stack: [],           // navigation stack for explorer: [{mode, key, label}]
      mode: "home",        // home | perdana | bb | bb_docs
      key: "",             // active key inside mode
      crumbs: ["Portal", "Dashboard"],
      activeId: "",        // active explorer item id
      filter: ""
    };

    // ===== Data (UI sample; replace later with your real doc links) =====
    const DATA = {
      home: {
        explorer: [
          { id:"quick_perdana", icon:"üéì", title:"Go to Perdana", sub:"Jump to modules", count:"‚Üí", tag:"Shortcut", action: () => selectSection("perdana") },
          { id:"quick_bb", icon:"üìÅ", title:"Bidang Bahasa", sub:"6 folders ‚Ä¢ 24 documents", count:"24", tag:"Popular", action: () => openBB() },
          { id:"recent", icon:"üïò", title:"Recent Documents", sub:"Last opened items", count:"6", tag:"Recent", action: () => openRecent() },
        ]
      },

      perdana: {
        explorer: [
          { id:"perdana_bb", icon:"üìÅ", title:"Bidang Bahasa", sub:"6 folders ‚Ä¢ 24 documents", count:"24", tag:"Folders", action: () => openBB() },
          { id:"perdana_sains", icon:"üìÅ", title:"Sains & Matematik", sub:"Modules pending", count:"‚Äî", tag:"Soon", action: () => showReader("placeholder","Sains & Matematik","Modules pending‚Ä¶") },
          { id:"perdana_sosial", icon:"üìÅ", title:"Sains Sosial", sub:"Modules pending", count:"‚Äî", tag:"Soon", action: () => showReader("placeholder","Sains Sosial","Modules pending‚Ä¶") },
          { id:"perdana_tvet", icon:"üìÅ", title:"TVET", sub:"Modules pending", count:"‚Äî", tag:"Soon", action: () => showReader("placeholder","TVET","Modules pending‚Ä¶") },
        ]
      },

      bbFolders: [
        { id:"bb_pengurusan", icon:"üìÅ", title:"Pengurusan Am", sub:"Carta ‚Ä¢ DSKP ‚Ä¢ RPH ‚Ä¢ Profil", count:"12", tag:"Core", action: () => openBBFolder("pengurusan") },
        { id:"bb_pekeliling", icon:"üìÅ", title:"Pekeliling", sub:"SPI & rujukan dasar", count:"4", tag:"Policy", action: () => openBBFolder("pekeliling") },
        { id:"bb_mesyuarat", icon:"üìÅ", title:"Mesyuarat", sub:"Surat panggilan & minit", count:"8", tag:"Meetings", action: () => openBBFolder("mesyuarat") },
        { id:"bb_pentaksiran", icon:"üìÅ", title:"Pentaksiran", sub:"Headcount ‚Ä¢ Post mortem ‚Ä¢ PBD", count:"10", tag:"Assessment", action: () => openBBFolder("pentaksiran") },
        { id:"bb_strategik", icon:"üìÅ", title:"Perancangan Strategik", sub:"Pelan taktikal & operasi", count:"6", tag:"Plan", action: () => openBBFolder("strategik") },
        { id:"bb_kewangan", icon:"üìÅ", title:"Kewangan", sub:"PCG ‚Ä¢ Nota minta ‚Ä¢ Invois", count:"5", tag:"Finance", action: () => openBBFolder("kewangan") },
      ],

      recentDocs: [
  { id:"r1", icon:"üìÑ", title:"SPI Bil 4/1986", sub:"Pekeliling ‚Ä¢ Panitia Mata Pelajaran", count:"PDF", tag:"Recent",
    action: () => { openBB(); openBBFolder("pekeliling"); } },

  { id:"r2", icon:"üìÑ", title:"DSKP Tingkatan 4", sub:"Pengurusan Am ‚Ä¢ DSKP", count:"PDF", tag:"Recent",
    action: () => { openBB(); openBBFolder("pengurusan"); } },

  { id:"r3", icon:"üìÑ", title:"Minit Mesyuarat Panitia 1", sub:"Mesyuarat ‚Ä¢ Minit", count:"DOC", tag:"Recent",
    action: () => { openBB(); openBBFolder("mesyuarat"); } },
],

    };

    // ===== Helpers =====
    function setCrumbs(parts){
      state.crumbs = parts;
      const el = document.getElementById("crumbs");
      el.innerHTML = "";
      parts.forEach((p, i) => {
        const b = document.createElement("button");
        b.className = "crumb";
        b.type = "button";
        b.textContent = p;
        b.onclick = () => crumbJump(i);
        el.appendChild(b);
        if(i < parts.length - 1){
          const s = document.createElement("span");
          s.className = "crumbSep";
          s.textContent = "‚Ä∫";
          el.appendChild(s);
        }
      });

      // Sidebar subtitle
      const sub = document.getElementById("sidebarSub");
      if(sub) sub.textContent = parts.slice(1).join(" ‚ñ∏ ");
    }

    function crumbJump(i){
      // Simple rules: 0=Portal, 1=Dashboard -> go home
      if(i <= 1){ selectSection("home"); return; }
      const name = state.crumbs[i];
      if(name === "Perdana") selectSection("perdana");
      if(name === "Bidang Bahasa") openBB();
    }

    function setActiveNav(section){
      document.querySelectorAll(".navBtn[data-section]").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-section") === section);
      });
    }

    function setExplorerLabel(text){
      document.getElementById("explPill").textContent = text;
    }
    function setViewLabel(text){
      document.getElementById("viewPill").textContent = text;
    }

    function renderExplorer(items){
      const list = document.getElementById("explList");
      list.innerHTML = "";
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "item";
        div.dataset.id = it.id;
        div.onclick = () => {
          state.activeId = it.id;
          highlightActiveExplorer();
          it.action && it.action();
        };

        div.innerHTML = `
          <div class="itemLeft">
            <div class="itemIco">${it.icon || "üìÅ"}</div>
            <div class="itemText">
              <b>${it.title}</b>
              <span>${it.sub || ""}</span>
            </div>
          </div>
          <div class="itemRight">
            <span class="count">${it.count ?? "‚Äî"}</span>
            ${it.tag ? `<span class="tag">${it.tag}</span>` : ``}
          </div>
        `;
        list.appendChild(div);
      });
      highlightActiveExplorer();
      filterList(); // apply current filter
    }

    function highlightActiveExplorer(){
      document.querySelectorAll("#explList .item").forEach(el => {
        el.classList.toggle("active", el.dataset.id === state.activeId);
      });
    }

    function filterList(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      state.filter = q;
      document.querySelectorAll("#explList .item").forEach(el => {
        const txt = el.textContent.toLowerCase();
        el.style.display = txt.includes(q) ? "" : "none";
      });
    }

    function setBackEnabled(v){
      const btn = document.getElementById("backBtn");
      btn.disabled = !v;
    }

    function pushStack(mode, key, label){
      state.stack.push({ mode, key, label });
      setBackEnabled(state.stack.length > 0);
    }

    function goBack(){
      if(state.stack.length === 0) return;
      const prev = state.stack.pop();
      setBackEnabled(state.stack.length > 0);

      // Restore previous screen
      if(prev.mode === "perdana"){
        selectSection("perdana", true);
      } else if(prev.mode === "bb"){
        openBB(true);
      } else if(prev.mode === "home"){
        selectSection("home", true);
      }
    }

    // ===== Reader views =====
    function showReader(view, title, subtitle, html){
      const r = document.getElementById("reader");

      if(view === "home"){
        const nm = window.__WELCOME_NAME__ || "<?= username ?>";
        r.innerHTML = `
          <div class="doc">
            <div class="docTitle">Welcome back, ${nm}.</div>
            <div class="docSub">
              Use the left navigation to open modules. Explorer shows folders & documents. Links are light-blue so users can instantly distinguish URLs from text.
            </div>

            <div class="heroGrid">
              <div class="heroCard">
                <h4>Quick Actions</h4>
                <p>Jump into Perdana or open Bidang Bahasa in one click.</p>
                <div class="tiles" style="margin-top:10px;">
                  <div class="tile" onclick="selectSection('perdana')">
                    <b>Open Perdana</b><span>Modules & panitia</span>
                  </div>
                  <div class="tile" onclick="openBB()">
                    <b>Bidang Bahasa</b><span>6 folders ‚Ä¢ 24 docs</span>
                  </div>
                </div>
              </div>

              <div class="heroCard">
                <h4>Recent</h4>
                <p class="small muted">Last opened items (sample)</p>
                <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
                  <div class="tile" onclick="openBBFolder('pekeliling')"><b>SPI Bil 4/1986</b><span>Pekeliling</span></div>
                  <div class="tile" onclick="openBBFolder('pengurusan')"><b>DSKP Tingkatan 4</b><span>Pengurusan Am</span></div>
                </div>
              </div>
            </div>

            <div class="heroCard" style="margin-top:12px;">
              <h4>How users navigate</h4>
              <p>
                1) Select a section (Sidebar) ‚Üí 2) Choose folder/doc (Explorer) ‚Üí 3) Read/open links (Document View).
              </p>
            </div>
          </div>
        `;
        setViewLabel("Dashboard");
        return;
      }

      if(view === "placeholder"){
        r.innerHTML = `
          <div class="doc">
            <div class="docTitle">${title || "Coming soon"}</div>
            <div class="docSub">${subtitle || "No content available yet."}</div>
            <div class="heroCard">
              <h4>Placeholder</h4>
              <p>This is a complete UI sample. You can later replace placeholders with real content.</p>
            </div>
          </div>
        `;
        setViewLabel(title || "Placeholder");
        return;
      }

      // Custom HTML view
      r.innerHTML = `
        <div class="doc">
          <div class="docTitle">${title || ""}</div>
          <div class="docSub">${subtitle || ""}</div>
          ${html || ""}
        </div>
      `;
      setViewLabel(title || "Document");
    }

    // ===== Navigation flows =====
    function selectSection(section, silent){
      state.section = section;
      state.mode = section;
      state.activeId = "";
      if(!silent){
        // reset stack when user explicitly selects a top section
        state.stack = [];
        setBackEnabled(false);
        document.getElementById("q").value = "";
      }

      setActiveNav(section);

      if(section === "home"){
        setCrumbs(["Portal","Dashboard"]);
        setExplorerLabel("Dashboard");
        renderExplorer(DATA.home.explorer);
        showReader("home");
        return;
      }

      if(section === "perdana"){
        setCrumbs(["Portal","Perdana"]);
        setExplorerLabel("Perdana");
        renderExplorer(DATA.perdana.explorer);
        showReader("placeholder","Perdana","Choose a module from Explorer.");
        return;
      }

      // Other sections (sample)
      setCrumbs(["Portal", titleCase(section)]);
      setExplorerLabel(titleCase(section));
      renderExplorer([
        { id:"none", icon:"‚ÑπÔ∏è", title:"No items yet", sub:`Explorer items for ${titleCase(section)} are not defined in this sample.`, count:"‚Äî", tag:"Info",
          action: () => showReader("placeholder", titleCase(section), "No sample content yet.") }
      ]);
      showReader("placeholder", titleCase(section), "No sample content yet.");
    }

    function openRecent(){
      pushStack("home","","Dashboard");
      setCrumbs(["Portal","Dashboard","Recent Documents"]);
      setExplorerLabel("Recent");
      renderExplorer(DATA.recentDocs);
      showReader("placeholder","Recent Documents","Sample list of recently opened items.");
    }

    function openBB(silent){
      if(!silent) pushStack("perdana","","Perdana");
      state.mode = "bb";
      state.activeId = "";
      document.getElementById("q").value = "";

      setCrumbs(["Portal","Perdana","Bidang Bahasa"]);
      setExplorerLabel("Bidang Bahasa");
      renderExplorer(DATA.bbFolders);
      showReader("placeholder","Bidang Bahasa","Choose a folder from Explorer.");
    }

    function openBBFolder(key){
      // entering a folder is a deeper screen, enable back
      if(state.mode !== "bb") openBB(); // ensure in BB mode
      // highlight matching explorer item
      const idMap = {
        pengurusan:"bb_pengurusan",
        pekeliling:"bb_pekeliling",
        mesyuarat:"bb_mesyuarat",
        pentaksiran:"bb_pentaksiran",
        strategik:"bb_strategik",
        kewangan:"bb_kewangan"
      };
      state.activeId = idMap[key] || "";
      highlightActiveExplorer();

      const labelMap = {
        pengurusan:"Pengurusan Am",
        pekeliling:"Pekeliling",
        mesyuarat:"Mesyuarat",
        pentaksiran:"Pentaksiran",
        strategik:"Perancangan Strategik",
        kewangan:"Kewangan"
      };
      const label = labelMap[key] || key;

      setCrumbs(["Portal","Perdana","Bidang Bahasa", label]);

      // Folder pages
      if(key === "pengurusan"){
        showReader("custom","Bidang Bahasa", "Folder: Pengurusan Am", `
          
          <div class="heroCard">
            <h4>Pengurusan Am</h4>
            <p>Everything operational: surat menyurat, carta organisasi, profil, DSKP, RPH.</p>
          </div>

          <div class="docList">
            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this); toggleSuratDropdown();">
                <div class="docTitleRow">
                  <div class="docTitle">üìÅ Surat Menyurat</div>
                  <div class="docMeta">Klik untuk buka</div>
                </div>
                <span class="count" id="suratStatus">Ready</span>
              </div>
              <div class="docBody">
                <div class="dropdown" id="suratDropdown" style="display:none;">
    <div class="dropdownHead">
      <div class="pill">Google Drive ‚Ä¢ Surat Menyurat</div>

      <div class="dropdownTools">
        <button class="miniBtn" id="suratConnectBtn" type="button" onclick="suratConnect()">
          üîë Connect
        </button>

        <input id="suratSearch" class="ddSearch" placeholder="Search filename..." oninput="suratSearchDebounced()" />
        <input id="suratUploadInput" type="file" style="display:none" onchange="suratUploadSelected(this.files[0])" />

        <button class="ddUploadBtn" type="button" onclick="document.getElementById('suratUploadInput').click()">
          ‚¨Ü Upload
        </button>
      </div>
    </div>

    <div class="ddBody" id="suratList">
      <div class="ddHint">Connect first to load files.</div>
    </div>
  </div>

              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Visi &amp; Misi KPM</div>
                  <div class="docMeta">Rujukan dasar</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <b>VISI</b>
                <p class="docP">Pendidikan Berkualiti, Insan Terdidik, Negara Sejahtera.</p>
                <b>MISI</b>
                <p class="docP">Melestarikan Sistem Pendidikan yang Berkualiti untuk membangunkan Potensi Individu bagi Memenuhi Aspirasi Negara.</p>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Struktur / Carta Organisasi JKKS &amp; Panitia</div>
                  <div class="docMeta">Carta organisasi &amp; jawatankuasa</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Butiran Peribadi Ahli Panitia</div>
                  <div class="docMeta">Profil &amp; daftar</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_DSKP_T1" target="_blank" rel="noopener">Daftar Profil Guru</a>
                  <a href="PASTE_LINK_DSKP_T2" target="_blank" rel="noopener">Profil Guru</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Jadual Waktu Persendirian Ahli Panitia</div>
                  <div class="docMeta">Waktu persendirian / relief</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Dokumen Standard Kurikulum dan Pentaksiran (DSKP)</div>
                  <div class="docMeta">Fail rujukan DSKP mengikut tingkatan</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_DSKP_T1" target="_blank" rel="noopener">DSKP T1</a>
                  <a href="PASTE_LINK_DSKP_T2" target="_blank" rel="noopener">DSKP T2</a>
                  <a href="PASTE_LINK_DSKP_T3" target="_blank" rel="noopener">DSKP T3</a>
                  <a href="PASTE_LINK_DSKP_T4" target="_blank" rel="noopener">DSKP T4</a>
                  <a href="PASTE_LINK_DSKP_T5" target="_blank" rel="noopener">DSKP T5</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Rancangan Pengajaran Tahunan (RPH guru perlu disemak)</div>
                  <div class="docMeta">RPH mengikut tingkatan</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_RPH_T1" target="_blank" rel="noopener">RPH T1</a>
                  <a href="PASTE_LINK_RPH_T2" target="_blank" rel="noopener">RPH T2</a>
                  <a href="PASTE_LINK_RPH_T3" target="_blank" rel="noopener">RPH T3</a>
                  <a href="PASTE_LINK_RPH_T4" target="_blank" rel="noopener">RPH T4</a>
                  <a href="PASTE_LINK_RPH_T5" target="_blank" rel="noopener">RPH T5</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Takwim Panitia</div>
                  <div class="docMeta">Perancangan tahunan panitia</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Jadual &amp; Analisis Pencerapan Guru (Standard 4 SKPMg2)</div>
                  <div class="docMeta">Instrumen &amp; evidens pencerapan</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Senarai Buku Teks / Buku Kerja / Buku Rujukan</div>
                  <div class="docMeta">Rujukan PdP</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead noToggle">
                <div class="docTitleRow">
                  <div class="docTitle">Takwim Aktiviti Ko-Akademik (Jika berkaitan)</div>
                  <div class="docMeta">Aktiviti sokongan akademik</div>
                </div>
                <span class="count">‚Äî</span>
              </div>
            </div>
          </div>

        `);
        return;
      }

      if(key === "pekeliling"){
        showReader("custom","Bidang Bahasa", "Folder: Pekeliling", `
          
          <div class="heroCard">
            <h4>Pekeliling</h4>
            <p>Collection of key SPI &amp; circular references.</p>
          </div>

          <div class="docList">
            <div class="docItem">
              <div class="docHead" onclick="window.open('https://drive.google.com/file/d/1Omg1TBWYB8Jn1jWRUQeWwVzH_UvafhI3/view?usp=sharing','_blank','noopener')">
                <div class="docTitleRow">
                  <div class="docTitle">SPI Bil 4/1986: Panitia Mata Pelajaran</div>
                  <div class="docMeta">Klik untuk buka</div>
                </div>
                <span class="count">‚Üó</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="window.open('https://drive.google.com/file/d/1R55lQSmldAr0un-G7LuyO_VmQ6IsXu7D/view?usp=sharing','_blank','noopener')">
                <div class="docTitleRow">
                  <div class="docTitle">SPI Bil 3/1987: Penyeliaan Pengajaran Pembelajaran</div>
                  <div class="docMeta">Klik untuk buka</div>
                </div>
                <span class="count">‚Üó</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="window.open('https://drive.google.com/file/d/1H-SOMz-KMyPXoLm0EVsZWgb9XD2nJxma/view?usp=sharing','_blank','noopener')">
                <div class="docTitleRow">
                  <div class="docTitle">SPI Bil 3/1999: Penyediaan Rekod PdP</div>
                  <div class="docMeta">Klik untuk buka</div>
                </div>
                <span class="count">‚Üó</span>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="window.open('PASTE_LINK_PEKELILING_LAIN','_blank','noopener')">
                <div class="docTitleRow">
                  <div class="docTitle">Pekeliling Lain Yang Berkaitan</div>
                  <div class="docMeta">Klik untuk buka</div>
                </div>
                <span class="count">‚Üó</span>
              </div>
            </div>
          </div>

        `);
        return;
      }

      if(key === "mesyuarat"){
        showReader("custom","Bidang Bahasa", "Folder: Mesyuarat", `
          
          <div class="heroCard">
            <h4>Mesyuarat</h4>
            <p>Surat panggilan &amp; minit JKKS / Panitia.</p>
          </div>

          <div class="docList">
            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Surat Panggilan Mesyuarat JKKS</div>
                  <div class="docMeta">Klik untuk buka senarai</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_JKKS_SURAT_1" target="_blank" rel="noopener">Surat Panggilan 1</a>
                  <a href="PASTE_LINK_JKKS_SURAT_2" target="_blank" rel="noopener">Surat Panggilan 2</a>
                  <a href="PASTE_LINK_JKKS_SURAT_3" target="_blank" rel="noopener">Surat Panggilan 3</a>
                  <a href="PASTE_LINK_JKKS_SURAT_4" target="_blank" rel="noopener">Surat Panggilan 4</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Minit Mesyuarat JKKS</div>
                  <div class="docMeta">Klik untuk buka senarai</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_JKKS_MINIT_1" target="_blank" rel="noopener">Mesyuarat JKKS 1</a>
                  <a href="PASTE_LINK_JKKS_MINIT_2" target="_blank" rel="noopener">Mesyuarat JKKS 2</a>
                  <a href="PASTE_LINK_JKKS_MINIT_3" target="_blank" rel="noopener">Mesyuarat JKKS 3</a>
                  <a href="PASTE_LINK_JKKS_MINIT_4" target="_blank" rel="noopener">Mesyuarat JKKS 4</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Surat Panggilan Mesyuarat Panitia</div>
                  <div class="docMeta">Klik untuk buka senarai</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_PANITIA_SURAT_1" target="_blank" rel="noopener">Surat Panggilan 1</a>
                  <a href="PASTE_LINK_PANITIA_SURAT_2" target="_blank" rel="noopener">Surat Panggilan 2</a>
                  <a href="PASTE_LINK_PANITIA_SURAT_3" target="_blank" rel="noopener">Surat Panggilan 3</a>
                  <a href="PASTE_LINK_PANITIA_SURAT_4" target="_blank" rel="noopener">Surat Panggilan 4</a>
                </div>
              </div>
            </div>

            <div class="docItem">
              <div class="docHead" onclick="toggleDoc(this);">
                <div class="docTitleRow">
                  <div class="docTitle">Minit Mesyuarat Panitia</div>
                  <div class="docMeta">Klik untuk buka senarai</div>
                </div>
                <span class="count">‚Üß</span>
              </div>
              <div class="docBody">
                <div class="docLinks">
                  <a href="PASTE_LINK_PANITIA_MINIT_1" target="_blank" rel="noopener">Mesyuarat Panitia 1</a>
                  <a href="PASTE_LINK_PANITIA_MINIT_2" target="_blank" rel="noopener">Mesyuarat Panitia 2</a>
                  <a href="PASTE_LINK_PANITIA_MINIT_3" target="_blank" rel="noopener">Mesyuarat Panitia 3</a>
                  <a href="PASTE_LINK_PANITIA_MINIT_4" target="_blank" rel="noopener">Mesyuarat Panitia 4</a>
                </div>
              </div>
            </div>
          </div>

        `);
        return;
      }

      if(key === "pentaksiran"){
        showReader("custom","Bidang Bahasa", "Folder: Pentaksiran", `
          
          <div class="heroCard">
            <h4>Pentaksiran</h4>
            <p>Headcount, post mortem, PBD reporting, item bank.</p>
          </div>

          <div class="docList">
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Takwim Pentaksiran</div><div class="docMeta">Jadual & tarikh pentaksiran</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Jadual Penyediaan Kertas Peperiksaan</div><div class="docMeta">Penyediaan instrumen</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Jadual Penyemakan Latihan Murid</div><div class="docMeta">Pemantauan latihan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Data dan Analisis Headcount</div><div class="docMeta">TOV / ETR / sasaran</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Analisis &amp; Laporan Post Mortem Peperiksaan Dalaman</div><div class="docMeta">PM dalaman</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Analisis &amp; Laporan Post Mortem Peperiksaan Awam</div><div class="docMeta">PM awam</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Pelaporan PBD</div><div class="docMeta">Rekod & pelaporan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Kerja Kursus (Jika berkaitan)</div><div class="docMeta">PA / KK</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Koleksi Soalan Peperiksaan &amp; JSU</div><div class="docMeta">Bank soalan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Koleksi Modul Pembelajaran</div><div class="docMeta">Modul / latihan</div></div><span class="count">‚Äî</span></div></div>
          </div>

        `);
        return;
      }

      if(key === "strategik"){
        showReader("custom","Bidang Bahasa", "Folder: Perancangan Strategik", `
          
          <div class="heroCard">
            <h4>Perancangan Strategik</h4>
            <p>Pelan taktikal, pelan operasi, program peningkatan.</p>
          </div>

          <div class="docList">
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Pelan Taktikal</div><div class="docMeta">Sasaran & strategi</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Pelan Operasi</div><div class="docMeta">Pelaksanaan tindakan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Perancangan Program Peningkatan Profesionalisme Guru</div><div class="docMeta">Perancangan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Pelaporan Program Peningkatan Profesionalisme Guru</div><div class="docMeta">Pelaporan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Perancangan Program Peningkatan Akademik Murid</div><div class="docMeta">Perancangan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Pelaporan Program Peningkatan Akademik Murid</div><div class="docMeta">Pelaporan</div></div><span class="count">‚Äî</span></div></div>
          </div>

        `);
        return;
      }

      if(key === "kewangan"){
        showReader("custom","Bidang Bahasa", "Folder: Kewangan", `
          
          <div class="heroCard">
            <h4>Kewangan</h4>
            <p>Agihan PCG, perancangan, invois &amp; rekod sumber.</p>
          </div>

          <div class="docList">
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Agihan PCG Mata Pelajaran</div><div class="docMeta">Agihan peruntukan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Perancangan Perbelanjaan</div><div class="docMeta">Bajet & perancangan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Nota Minta</div><div class="docMeta">Permohonan</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Invois</div><div class="docMeta">Rekod pembelian</div></div><span class="count">‚Äî</span></div></div>
            <div class="docItem"><div class="docHead noToggle"><div class="docTitleRow"><div class="docTitle">Rekod Penggunaan Sumber Pendidikan</div><div class="docMeta">Log penggunaan</div></div><span class="count">‚Äî</span></div></div>
          </div>

        `);
        return;
      }

      showReader("placeholder","Bidang Bahasa", `Folder: ${label}`, "No sample content yet.");
    }

    function titleCase(s){
      return (s||"").charAt(0).toUpperCase() + (s||"").slice(1);
    }

    // ===== Keyboard shortcuts =====
    window.addEventListener("keydown", (e) => {
      if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
        e.preventDefault();
        document.getElementById("q").focus();
        return;
      }
      if(e.key === "Escape"){
        if(!document.getElementById("backBtn").disabled) goBack();
      }
    });

    let __suratLoadedOnce = false;
let __suratSearchTimer = null;

/***********************
 * SURAT MENYURAT (Google Drive)
 * Folder wired to: 1FJmQlTmU-AWBG493aW6-7MtFfPZKlrUs
 *
 * REQUIRED (once):
 * 1) Create OAuth Client ID (Web) in Google Cloud Console
 * 2) Enable Google Drive API
 * 3) Put your client id below
 * 4) Add Authorized JavaScript origins:
 *    - your hosting domain (e.g. https://dashboard-smkg.web.app)
 *    - http://localhost:5000 (if testing locally with firebase)
 ***********************/
const SURAT = {
  folderId: "1FJmQlTmU-AWBG493aW6-7MtFfPZKlrUs",
  clientId: "1038954916652-72hpdrckr1eachacq79rp2le8k8eopre.apps.googleusercontent.com", // TODO: replace
  scope: "https://www.googleapis.com/auth/drive",
  tokenClient: null,
  accessToken: "",
  expiresAt: 0
};

function suratInitTokenClient(){
  if(SURAT.tokenClient) return;
  if(!(window.google && google.accounts && google.accounts.oauth2)) return;

  SURAT.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: SURAT.clientId,
    scope: SURAT.scope,
    callback: (resp) => {
      if(resp && resp.access_token){
        SURAT.accessToken = resp.access_token;
        SURAT.expiresAt = Date.now() + ((resp.expires_in || 3600) * 1000) - 30_000;
        suratSetStatus("Connected");
        // auto load latest when first connected
        __suratLoadedOnce = false;
        suratLoadLatest();
      }else{
        console.error("OAuth response:", resp);
        suratSetStatus("Auth failed");
      }
    }
  });
}

function suratConnect(){
  if(!(window.google && google.accounts && google.accounts.oauth2)){
    suratSetStatus("Loading auth‚Ä¶");
    setTimeout(suratConnect, 500);
    return;
  }
  suratInitTokenClient();
  SURAT.tokenClient.requestAccessToken({ prompt: "consent" });
}

async function suratEnsureToken(){
  if(SURAT.accessToken && Date.now() < SURAT.expiresAt) return SURAT.accessToken;

  if(!(window.google && google.accounts && google.accounts.oauth2)){
    await new Promise(r => setTimeout(r, 600));
  }
  suratInitTokenClient();

  return await new Promise((resolve, reject) => {
    try{
      SURAT.tokenClient.callback = (resp) => {
        if(resp && resp.access_token){
          SURAT.accessToken = resp.access_token;
          SURAT.expiresAt = Date.now() + ((resp.expires_in || 3600) * 1000) - 30_000;
          suratSetStatus("Connected");
          resolve(SURAT.accessToken);
        }else{
          suratSetStatus("Auth failed");
          reject(new Error("No access token"));
        }
      };
      // try silent first
      SURAT.tokenClient.requestAccessToken({ prompt: "" });
    }catch(err){
      reject(err);
    }
  });
}

function toggleSuratDropdown(){
  const dd = document.getElementById("suratDropdown");
  if(!dd) return;

  const open = dd.style.display !== "none";
  dd.style.display = open ? "none" : "block";

  if(!open && !__suratLoadedOnce){
    suratLoadLatest();
  }
}

function suratSetStatus(text){
  const el = document.getElementById("suratStatus");
  if(el) el.textContent = text;
}

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch(e){
    return iso || "";
  }
}

function renderSuratFiles(files, modeLabel){
  const list = document.getElementById("suratList");
  if(!list) return;

  if(!files || files.length === 0){
    list.innerHTML = `<div class="ddHint">No files found.</div>`;
    suratSetStatus(modeLabel || "Empty");
    return;
  }

  list.innerHTML = files.map(f => {
    const openUrl = f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`;
    return `
      <div class="fileRow">
        <div class="fileLeft">
          <b title="${escapeHtml(f.name)}">${escapeHtml(f.name)}</b>
          <span>Updated: ${fmtDate(f.modifiedTime)} ‚Ä¢ ${escapeHtml(f.mimeType || "")}</span>
        </div>
        <div class="fileRight">
          <button class="openBtn" type="button" onclick="window.open('${openUrl}','_blank','noopener')">Open ‚Üó</button>
          <button class="delBtn" type="button" onclick="suratDelete('${f.id}','${escapeHtml(f.name).replaceAll("'","&#039;")}')">Delete</button>
        </div>
      </div>
    `;
  }).join("");

  suratSetStatus(modeLabel || "OK");
}

async function suratListDriveFiles({ term="", limit=5 }){
  const token = await suratEnsureToken();
  let q = `'${SURAT.folderId}' in parents and trashed=false`;
  if(term){
    const safe = term.replace(/'/g, "\\'");
    q += ` and name contains '${safe}'`;
  }

  const params = new URLSearchParams({
    q,
    pageSize: String(limit),
    orderBy: "modifiedTime desc",
    fields: "files(id,name,mimeType,modifiedTime,webViewLink)"
  });

  const res = await fetch(`https://www.googleapis.com/drive/v3/files?${params.toString()}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  if(!res.ok){
    const t = await res.text();
    throw new Error(`Drive list failed (${res.status}): ${t}`);
  }
  const data = await res.json();
  return data.files || [];
}

async function suratLoadLatest(){
  suratSetStatus("Loading‚Ä¶");
  const list = document.getElementById("suratList");
  if(list) list.innerHTML = `<div class="ddHint">Loading latest files‚Ä¶</div>`;

  try{
    const files = await suratListDriveFiles({ term:"", limit: 5 });
    __suratLoadedOnce = true;
    renderSuratFiles(files, "Latest");
  }catch(err){
    console.error(err);
    suratSetStatus("Not connected");
    if(list) list.innerHTML = `<div class="ddHint">Click <b>Connect</b>. If already connected, check OAuth Client ID + Drive API enablement.</div>`;
  }
}

function suratSearchDebounced(){
  clearTimeout(__suratSearchTimer);
  __suratSearchTimer = setTimeout(suratDoSearch, 250);
}

async function suratDoSearch(){
  const q = (document.getElementById("suratSearch")?.value || "").trim();
  if(!q){
    suratLoadLatest();
    return;
  }

  suratSetStatus("Searching‚Ä¶");
  const list = document.getElementById("suratList");
  if(list) list.innerHTML = `<div class="ddHint">Searching ‚Äú${escapeHtml(q)}‚Äù‚Ä¶</div>`;

  try{
    const files = await suratListDriveFiles({ term: q, limit: 20 });
    renderSuratFiles(files, "Search");
  }catch(err){
    console.error(err);
    suratSetStatus("Error");
    if(list) list.innerHTML = `<div class="ddHint">Search failed. Ensure you are connected and have access to the folder.</div>`;
  }
}

async function suratUploadSelected(file){
  if(!file) return;

  suratSetStatus("Uploading‚Ä¶");
  const list = document.getElementById("suratList");
  if(list) list.innerHTML = `<div class="ddHint">Uploading ${escapeHtml(file.name)}‚Ä¶</div>`;

  try{
    const token = await suratEnsureToken();

    const metadata = {
      name: file.name,
      parents: [SURAT.folderId]
    };

    const boundary = "-------314159265358979323846";
    const delimiter = `\r\n--${boundary}\r\n`;
    const closeDelim = `\r\n--${boundary}--`;

    const metaPart =
      delimiter +
      'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
      JSON.stringify(metadata);

    const filePart =
      delimiter +
      `Content-Type: ${file.type || "application/octet-stream"}\r\n\r\n`;

    const body = new Blob([metaPart, filePart, file, closeDelim]);

    const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": `multipart/related; boundary=${boundary}`
      },
      body
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`Upload failed (${res.status}): ${t}`);
    }

    suratSetStatus("Uploaded");
    // reset search & reload latest
    document.getElementById("suratSearch").value = "";
    __suratLoadedOnce = false;
    suratLoadLatest();
  }catch(err){
    console.error(err);
    suratSetStatus("Error");
    if(list) list.innerHTML = `<div class="ddHint">Upload failed. Check permissions / OAuth settings.</div>`;
  }finally{
    const input = document.getElementById("suratUploadInput");
    if(input) input.value = "";
  }
}

async function suratDelete(fileId, name){
  const ok = confirm(`Delete "${name}"?`);
  if(!ok) return;

  try{
    suratSetStatus("Deleting‚Ä¶");
    const token = await suratEnsureToken();
    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`Delete failed (${res.status}): ${t}`);
    }

    suratSetStatus("Deleted");
    // refresh current view (search or latest)
    const q = (document.getElementById("suratSearch")?.value || "").trim();
    if(q) suratDoSearch(); else suratLoadLatest();
  }catch(err){
    console.error(err);
    suratSetStatus("Error");
    alert("Delete failed. Check permissions.");
  }
}
/* tiny helper */
function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}


function toggleDoc(el){
  if(!el) return;
  if(el.classList && el.classList.contains("noToggle")) return;
  const item = el.closest(".docItem");
  if(!item) return;
  item.classList.toggle("open");
}


    // ===== Init =====
    patchDemoUserIfNeeded();
    selectSection("home");
  </script>
</body>
</html>
